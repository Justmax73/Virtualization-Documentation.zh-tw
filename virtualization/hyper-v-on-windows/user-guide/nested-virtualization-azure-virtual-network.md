---
title: 將嵌套的 Vm 設定為直接與 Azure 虛擬網路中的資源進行通訊
description: 巢狀虛擬化
keywords: windows 10，hyper-v，Azure
author: mrajess
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: efd180c458457da1cea6b379e21ba3a37083d15a
ms.sourcegitcommit: 1ca9d7562a877c47f227f1a8e6583cb024909749
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/04/2019
ms.locfileid: "74910958"
---
# <a name="configure-nested-vms-to-communicate-with-resources-in-an-azure-virtual-network"></a>設定要與 Azure 虛擬網路中的資源進行通訊的嵌套 Vm

如需在 Azure 中部署和設定嵌套虛擬機器的原始指引，您必須透過 NAT 交換器存取這些 Vm。 這會提供幾項限制：

1. 嵌套 Vm 無法存取內部部署或 Azure 虛擬網路中的資源。
2. Azure 中的內部部署資源或資源只能透過 NAT 存取嵌套的 Vm，這表示多個來賓無法共用相同的埠。

本檔將逐步引導您進行部署，讓我們使用 RRAS、使用者定義的路由、專用於輸出 NAT 的子網來允許存取網際網路，以及使用「浮動」的位址空間，讓嵌套的 Vm 與任何其他虛擬機器的行為和通訊直接部署到 Azure 中的 VNet。

開始本指南之前，請先：

1. 閱讀[這裡提供](https://docs.microsoft.com/azure/virtual-machines/windows/nested-virtualization)的「嵌套式虛擬化」指導方針。
2. 在執行之前，請先閱讀整篇文章。

## <a name="high-level-overview-of-what-were-doing-and-why"></a>我們正在進行的作業和原因的高階總覽
* 我們將建立具有兩個 Nic 的可支援嵌套 VM。 
* 一個 NIC 將用來提供具有透過 NAT 的網際網路存取的嵌套 Vm，而另一個 NIC 則用來將來自內部交換器的流量路由傳送至虛擬程式外部的資源。 每個 NIC 都必須位於不同的路由網域中，這表示不同的子網。
* 這表示我們需要至少三個子網的虛擬網路。 一個用於 NAT，一個用於 LAN 路由，另一個未使用，但在我們的嵌套 Vm 中為「已保留」。 我們在本檔中用於子網的名稱是、「NAT」、「Hyper-v-LAN」和「幻影」。
* 這些子網的大小是由您自行決定，但仍有一些考慮。 「幻影」子網的大小會決定您的嵌套 Vm 有多少 Ip。 此外，「NAT」和「Hyper-v-LAN」子網的大小，會決定您有多少個用於虛擬機器的 Ip。 因此，如果您只打算有一或兩個虛擬機器，您就可以在此建立非常小的子網。
* 背景：即使您設定了內部或外部交換器，嵌套 Vm 也不會從其主機所連線的 VNet 接收 DHCP。 
  * 這表示 Hyper-v 主機必須提供 DHCP。
* Hyper-v 主機不知道 VNet 上目前指派的租用，因此為了避免主機指派已存在之 IP 的情況，我們必須配置一組 ip 區塊，供 Hyper-v 主機用來使用。 這可讓我們避免重複的 IP 案例。
  * 我們選擇的 Ip 區塊會對應到您的 Hyper-v 所在的相同 VNet 中的子網。
  * 我們希望此對應至現有子網的原因，是要處理透過 ExpressRoute 傳回的 BGP 公告。 如果我們只是為了要使用的 Hyper-v 主機組成 IP 範圍，則必須建立一系列的靜態路由，讓內部部署用戶端能夠與嵌套 Vm 通訊。 這表示這不是一項很難的需求，因為您可以為嵌套的 Vm 組成 IP 範圍，然後建立將用戶端導向該範圍的 Hyper-v 主機所需的所有路由。
* 我們會在 Hyper-v 內建立內部交換器，然後在保留給 DHCP 的範圍內，為新建立的介面指派 IP 位址。 此 IP 位址會成為我們的嵌套 Vm 的預設閘道，並用來在內部交換器與連線到 VNet 的主機 NIC 之間進行路由。
* 我們將在主機上安裝路由及遠端存取角色，這會將主機轉換成路由器。  這是允許主機外部資源與我們的嵌套 Vm 之間通訊的必要動作。
* 我們會告訴其他資源如何存取這些嵌套 Vm。 如此一來，我們就可以建立使用者定義的路由表，其中包含嵌套 Vm 所在 IP 範圍的靜態路由。 此靜態路由會指向 Hyper-v 的 IP 位址。
* 接著，您會將此 UDR 放在閘道子網上，讓來自內部部署的用戶端知道如何連接到我們的嵌套 Vm。
* 您也會將此 UDR 放在 Azure 中需要連線到嵌套 Vm 的任何其他子網上。
* 針對多部 Hyper-v 主機，您會建立額外的「浮動」子網，並將額外的靜態路由新增至 UDR。
* 當您解除委任 Hyper-v 主機時，您會刪除/重新調整「浮動」子網，並從我們的 UDR 移除該靜態路由，或者如果這是最後一部 Hyper-v 主機，請將 UDR 全部移除。

## <a name="creating-the-host"></a>建立主機

我會對任何以個人喜好設定（例如 VM 名稱、資源群組等）進行的設定值進行高光。

1. 流覽至 portal.azure.com
2. 按一下左上方的 [建立資源]
3. 從熱門的資料行中選取 [Window Server 2016 VM]
4. 在 [基本] 索引標籤上，請務必選取能夠嵌套虛擬化的 VM 大小
5. 移至 [網路] 索引標籤
6. 使用下列設定建立新的虛擬網路
    * VNet 位址空間： 10.0.0.0/22
    * 子網路 1
        * 名稱： NAT
        * 位址空間： 10.0.0.0/24
    * 子網路 2
        * 名稱： Hyper-v-LAN
        * 位址空間： 10.0.1.0/24
    * 子網路 3
        * 名稱：幻影
        * 位址空間： 10.0.2.0/24
    * 子網4
        * 名稱： Azure-Vm
        * 位址空間： 10.0.3.0/24
7. 請確定您已選取 VM 的 NAT 子網
8. 移至 [審查 + 建立]，然後選取 [建立]

## <a name="create-the-second-network-interface"></a>建立第二個網路介面
1. 在 VM 完成布建之後，請在 Azure 入口網站中流覽至它
2. 停止 VM
3. 一旦停止，請移至 [設定] 底下的 [網路]
4. [附加網路介面]
5. 「建立網路介面」
6. 為它命名（這並不重要，但請務必記住）
7. 針對子網選取 [Hyper-v-LAN]
8. 請確定您選取的是您的主機所在的相同資源群組
9. 建立
10. 這會讓您回到上一個畫面，請務必選取新建立的網路介面，然後選取 [確定]。
11. 返回 [總覽] 窗格，並在上一個動作完成後再次啟動您的 VM
12. 流覽至剛才建立的第二個 NIC，您可以在先前選取的資源群組中找到它
13. 移至 [IP 設定]，並將 [IP 轉送] 切換為 [已啟用]，然後儲存變更

## <a name="setting-up-hyper-v"></a>設定 Hyper-v
1. 遠端至您的主機
2. 開啟已提升許可權的 PowerShell 提示字元
3. 執行下列命令：`Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart`
4. 這會重新開機主機
5. 重新連線至主機，以繼續進行安裝程式的其餘部分

## <a name="creating-our-virtual-switch"></a>建立我們的虛擬交換器

1. 在系統管理模式中開啟 PowerShell。
2. 建立內部交換器： `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. 將新建立的介面指派為 IP： `New-NetIPAddress –IPAddress 10.0.2.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"`

## <a name="install-and-configure-dhcp"></a>安裝和設定 DHCP

*許多人在第一次嘗試讓嵌套虛擬化運作時，會遺漏此元件。不同于內部部署，您的來賓 Vm 將會從您主機所在的網路接收 DHCP，Azure 中的嵌套 Vm 必須透過其執行所在的主機來提供 DHCP。您也必須以靜態方式將 IP 位址指派給每個不具擴充性的嵌套 VM。*

1. 安裝 DHCP 角色： `Install-WindowsFeature DHCP -IncludeManagementTools`
2. 建立 DHCP 領域： `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.2.2 -EndRange 10.0.2.254 -SubnetMask 255.255.255.0`
3. 設定範圍的 DNS 和預設閘道選項： `Set-DhcpServerV4OptionValue -DnsServer 168.63.129.16 -Router 10.0.2.1`
    * 如果您想要讓名稱解析正常執行，請務必輸入有效的 DNS 伺服器。 在此情況下，我會使用[Azure 的遞迴 DNS](https://docs.microsoft.com/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances)。

## <a name="installing-remote-access"></a>安裝遠端存取

1. 開啟伺服器管理員，然後選取 [新增角色及功能]。
2. 選取 [下一步]，直到到達 [伺服器角色] 為止。
3. 勾選 [遠端存取]，然後按 [下一步]，直到您到達「角色服務」為止。
4. 勾選 [路由]，選取 [新增功能]，然後選取 [下一步]，再按 [安裝]。 完成嚮導並等候安裝完成。

## <a name="configuring-remote-access"></a>設定遠端存取

1. 開啟伺服器管理員並選取 [工具]，然後選取 [路由及遠端存取]。
2. 在 [路由及遠端存取] 管理面板的左側，您會在其旁邊看到具有伺服器名稱的圖示，以滑鼠右鍵按一下它，然後選取 [設定和啟用路由及遠端存取]。
3. 在嚮導上選取 [下一步]，檢查 [自訂設定] 的星形按鈕，然後選取 [下一步]。
4. 核取 [NAT] 和 [LAN 路由]，然後選取 [下一步]，然後按一下 [完成]。 如果它要求您啟動服務，請執行此動作。
5. 現在，流覽至 [IPv4] 節點並將它展開，讓 [NAT] 節點可供使用。
6. 以滑鼠右鍵按一下 [NAT]，選取 [新增介面 ...]然後選取 [Ethernet]，這應該是您的第一個 IP 為 "10.0.0.4" 的 NIC
7. 現在，我們需要建立一些靜態路由，以強制將 LAN 流量輸出到第二個 NIC。 若要這麼做，請前往 [IPv4] 底下的 [靜態路由] 節點。
8. 之後，我們會建立下列路由。
    * 路由1
        * 介面： Ethernet
        * 目的地：10.0.0。0
        * 網路遮罩：255.255.255。0
        * 閘道：10.0.0。1
        * 度量：256
        * 注意：我們會將此放入此處，以允許主要 NIC 回應其本身介面的目標流量。 如果這裡沒有此項，下列路由會導致 NIC 1 的流量進入 NIC 2。 這會建立非對稱式路由。 10.0.0.1 是 Azure 指派給 NAT 子網的 IP 位址。 Azure 會使用範圍中的第一個可用 IP 做為預設閘道。 因此，如果您將 192.168.0.0/24 用於 NAT 子網，閘道會是192.168.0.1。 在 [路由更明確的路由] 中，表示此路由將會取代下列路由。

    * 路線2
        * 介面： Ethernet 2
        * 目的地：10.0.0。0
        * 網路遮罩：255.255.252。0
        * 閘道：10.0.1。1
        * 度量：256
        * 注意：這是適用于 Azure VNet 之流量的「全部攔截」路由。 它會強制輸出第二個 NIC 的流量。 您必須為您想要讓您的嵌套 Vm 存取的其他範圍新增其他路由。 因此，如果您的內部部署網路為 172.16.0.0/22，則您會想要有另一個路由，將該流量傳送給我們的虛擬程式的第二個 NIC。

## <a name="creating-a-route-table-within-azure"></a>在 Azure 中建立路由表

如需深入瞭解如何在 Azure 中建立及管理路由，請參閱[這篇文章](https://docs.microsoft.com/azure/virtual-network/tutorial-create-route-table-portal)。

1. 瀏覽到 https://portal.azure.com 。
2. 在左上角，選取 [建立資源]。
3. 在搜尋欄位中輸入「路由表」，然後按 enter 鍵。
4. 最上方的結果會是 [路由表]，選取此，然後選取 [建立]
5. 為路由表命名，在我的案例中，我將其命名為「適用于嵌套 Vm 的路由」。
6. 請確定您選取的是 Hyper-v 主機所在的相同訂用帳戶。
7. 請建立新的資源群組，或選取現有的資源群組，並確定您在中建立路由表的區域與 Hyper-v 主機所在的區域相同。
8. 選取 [建立]。

## <a name="configuring-the-route-table"></a>設定路由表

1. 流覽至剛才建立的路由表。 若要這麼做，您可以從入口網站頂端中央的搜尋列中搜尋路由表的名稱。
2. 選取路由表之後，請移至分頁中的 [路由]。
3. 選取 [新增]。
4. 為您的路線命名，我使用的是「嵌套 Vm」。
5. 針對 [位址首碼]，輸入我們「浮動」子網的 IP 範圍。 在此情況下，它會是 10.0.2.0/24。
6. 在 [下一個躍點類型] 中，選取 [虛擬裝置]，然後輸入 Hyper-v 主機第二個 NIC 的 IP 位址，這會是10.0.1.4，然後選取 [確定]。
7. 現在從分頁中選取 [子網]，這會直接位於 [路由] 正下方。
8. 選取 [關聯]，然後選取我們的「我的最有趣」 VNet，再選取「Azure Vm」子網，然後選取 [確定]。
9. 針對 Hyper-v 主機所在的子網，以及任何其他需要存取嵌套 Vm 的子網，執行相同的程式。 如果已連接 

# <a name="end-state-configuration-reference"></a>結束狀態設定參考
本指南中的環境具有下列設定。 這一節是 inteded 來做為參考之用。

1. Azure 虛擬網路資訊。
    * VNet 高層級設定。
        * 名稱：嵌套-有趣
        * 位址空間： 10.0.0.0/22
        * 注意：這會由四個子網組成。 此外，這些範圍也不會在石子中設定。 您可以隨意處理您的環境。 

    * 第一個子網高層級設定。
        * 名稱： NAT
        * 位址空間： 10.0.0.0/24
        * 注意：這是我們的 Hyper-v 主機主要 NIC 所在的位置。 這將用來處理嵌套 Vm 的輸出 NAT。 這會是您的嵌套 Vm 的網際網路閘道。

    * 第二個子網高層級設定。
        * 名稱： Hyper-v-LAN
        * 位址空間： 10.0.1.0/24
        * 注意：我們的 Hyper-v 主機將會有第二個 NIC，用來處理在 Hyper-v 主機外部的嵌套 Vm 和非網際網路資源之間的路由。

    * 第三個子網高層級設定。
        * 名稱：幻影
        * 位址空間： 10.0.2.0/24
        * 注意：這會是「浮動」子網。 此位址空間將由我們的嵌套 Vm 取用，並存在以處理回到內部部署的路由通告。 將不會實際將任何 Vm 部署到此子網。

    * 第四個子網高層級設定。
        * 名稱： Azure-Vm
        * 位址空間： 10.0.3.0/24
        * 注意：包含 Azure Vm 的子網。

1. 我們的 Hyper-v 主機具有下列 NIC 設定。
    * 主要 NIC 
        * IP 位址：10.0.0。4
        * 子網路遮罩：255.255.255.0
        * 預設閘道：10.0.0。1
        * DNS：為 DHCP 設定
        * 已啟用 IP 轉送：否

    * 次要 NIC
        * IP 位址：10.0.1。4
        * 子網路遮罩：255.255.255.0
        * 預設閘道：空白
        * DNS：為 DHCP 設定
        * 已啟用 IP 轉送：是

    * Hyper-v 已針對內部虛擬交換器建立 NIC
        * IP 位址：10.0.2。1
        * 子網路遮罩：255.255.255.0
        * 預設閘道：空白

3. 我們的路由表會有單一規則。
    * 規則 1
        * 名稱：嵌套 Vm
        * 目的地： 10.0.2.0/24
        * 下一個躍點：虛擬裝置-10.0.1。4

## <a name="conclusion"></a>結論

您現在應該能夠將虛擬機器（甚至是32位 VM！）部署至 Hyper-v 主機，並讓它可從內部部署和 Azure 中存取。
