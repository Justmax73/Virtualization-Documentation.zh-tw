---
title: 將嵌套式 Vm 設定為直接與 Azure 虛擬網路中的資源進行通訊
description: 巢狀虛擬化
keywords: windows 10、hyper-v、Azure
author: mrajess
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: efd180c458457da1cea6b379e21ba3a37083d15a
ms.sourcegitcommit: c4a3f88d1663dd19336bfd4ede0368cb18550ac7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/31/2019
ms.locfileid: "9883261"
---
# <a name="configure-nested-vms-to-communicate-with-resources-in-an-azure-virtual-network"></a>設定嵌套式 Vm 以與 Azure 虛擬網路中的資源通訊

在 Azure 中部署及設定嵌套虛擬機器的原始指導方針, 是您必須透過 NAT 交換器存取這些 Vm。 這提供幾項限制:

1. 嵌套式 Vm 無法存取內部部署或 Azure 虛擬網路中的資源。
2. 在 Azure 中內部部署的資源或資源只能透過 NAT 存取嵌套式 Vm, 這表示多個來賓不能共用同一個埠。

本檔將逐步進行部署, 讓我們使用 RRAS、使用者定義的路由、專用於輸出 NAT 的子網, 以允許來賓網際網路存取, 以及「浮動」位址空間, 以允許嵌套式 Vm 與任何其他虛擬機器一樣進行行為和通訊直接部署到 Azure 中的 VNet。

開始本指南之前, 請:

1. 閱讀這裡在嵌套式虛擬化中[提供的指導](https://docs.microsoft.com/azure/virtual-machines/windows/nested-virtualization)方針。
2. 在實施前請先閱讀本文的完整文章。

## <a name="high-level-overview-of-what-were-doing-and-why"></a>我們正在進行的工作及原因的高層概覽
* 我們將建立具有兩個 Nic 的支援嵌套虛擬機器。 
* 一個 NIC 將用來提供我們的嵌套式 Vm, 透過 NAT 透過網際網路存取, 而另一個 NIC 將用來將來自內部交換器的流量路由到管理程式外部的資源。 每個 NIC 都必須位於不同的路由網域中, 這也就是不同的子網。
* 這表示我們需要至少有三個子網的虛擬網路。 一個適用于 NAT, 一個用於局域網路由, 另一個用於我們的嵌套式 Vm, 但是「保留」。 我們在此檔的子網中使用的名稱為「NAT」、「Hyper-v-LAN」和「幻像」。
* 這些子網的大小由您決定, 但有一些考慮。 [幻影] 子網的大小決定您針對嵌套式 Vm 有多少個 Ip。 此外, "NAT" 和 "Hyper-v-局域網" 子網的大小決定您針對虛擬機器監控程式所擁有的 IPs 數。 因此, 如果您只是規劃一或兩個虛擬機器監控程式, 您就可以從技術角度在這裡建立真正的小型子網。
* 背景: 即使您設定了內部或外部交換器, 嵌套式 Vm 也不會從 VNet 中接收與其主機連線的 DHCP。 
  * 這表示 Hyper-v 主機必須提供 DHCP。
* Hyper-v 主機不會知道 VNet 中目前指派的租約, 所以為了避免主機指派 IP 已存在的情況, 我們必須先將一個 ip 區塊指派給 Hyper-v 主機, 以供使用。 這可讓我們避免重複的 IP 案例。
  * 我們選擇的 IPs 區塊會對應到您的 Hyper-v 所在的同一個 VNet 中的子網。
  * 我們想要將它與現有的子網相對應的原因是要在 ExpressRoute 上處理 BGP 播發。 如果我們只是將 Hyper-v 主機的 IP 範圍製作成使用, 我們必須建立一系列的靜態路由, 讓用戶端內部部署與嵌套的虛擬機器進行通訊。 這表示這不是硬性需求, 因為您可以為嵌套的虛擬機器建立 IP 範圍, 然後建立將用戶端引導至該範圍的 Hyper-v 主機所需的所有路由。
* 我們會在 Hyper-v 中建立內部交換器, 然後將新建立的介面指派給我們為 DHCP 設定的範圍內的 IP 位址。 這個 IP 位址會成為我們的嵌套 Vm 的預設閘道, 並可用於在內部交換器與與我們的 VNet 連線之主機的 NIC 之間路由。
* 我們會在主機上安裝路由和遠端存取角色, 這會將主機轉成路由器。  這是允許主機外部資源與我們的嵌套 Vm 之間的通訊的必要。
* 我們將告知其他資源如何存取這些嵌套的虛擬機器。 這是為了讓我們建立一個使用者定義的路由資料表, 其中包含嵌套式 Vm 所在之 IP 範圍的靜態路由。 這個靜態路由會指向 Hyper-v 的 IP 位址。
* 然後將這個 UDR 放在閘道子網上, 讓來自內部部署的客戶知道如何存取我們的嵌套虛擬機器。
* 您也可以將這個 UDR 放在 Azure 中需要連線至嵌套式 Vm 的任何其他子網上。
* 對於多個 Hyper-v 主機, 您需要建立其他的「浮動」子網, 然後在 UDR 中新增額外的靜態路由。
* 當您停止使用 Hyper-v 主機時, 您將會刪除/重新調整 "浮動" 子網, 並從我們的 UDR 中移除該靜態路由, 或者如果這是最後一個 Hyper-v 主機, 請完全移除 UDR。

## <a name="creating-the-host"></a>建立主機

我將會在任何由個人喜好設定 (例如 [VM 名稱]、[資源群組] 等等) 的設定值上, 重新進行。

1. 流覽至 portal.azure.com
2. 按一下左上方的 [建立資源]
3. 從 [熱門] 資料行選取 [Window Server 2016 VM]
4. 在 [基本功能] 索引標籤上, 請務必選取支援嵌套虛擬化的 VM 大小
5. 移至 [網路] 索引標籤
6. 使用下列設定建立新的虛擬網路
    * VNet 位址空間: 10.0.0.0/22
    * 子網1
        * 名稱: NAT
        * 位址空間: 10.0.0.0/24
    * 子網2
        * Name (名稱): Hyper-v-局域網
        * 位址空間: 10.0.1.0/24
    * 子網3
        * 名稱: 重影
        * 位址空間: 10.0.2.0/24
    * 子網4
        * 名稱: Azure-Vm
        * 位址空間: 10.0.3.0/24
7. 確定您已選取 VM 的 NAT 子網
8. 移至 [查看 + 建立], 然後選取 [建立]

## <a name="create-the-second-network-interface"></a>建立第二個網路介面
1. 在 VM 完成提供在 Azure 入口網站中流覽至它之後
2. 停止 VM
3. 停止後, 移至 [設定] 底下的 [網路]
4. "附加網路介面"
5. "建立網路介面"
6. 為它命名 (與您命名的名稱無關), 但請務必記住它)。
7. 針對子網選取 "Hyper-v-局域網"
8. 確保您選取的主機所在的資源群組
9. 建立
10. 這會將您帶回前一個畫面, 請務必選取新建立的網路介面, 然後選取 [確定]
11. 回到 [一覽] 窗格, 並在上一個動作完成後再次啟動您的 VM
12. 流覽至我們剛剛建立的第二個 NIC, 您可以在先前選取的資源群組中找到它。
13. 移至 [IP 設定] 並將 [IP 轉寄] 切換為 [已啟用], 然後儲存變更

## <a name="setting-up-hyper-v"></a>設定 Hyper-v
1. 遠端到您的主機
2. 開啟提升許可權的 PowerShell 提示
3. 執行下列命令 `Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart`
4. 這將會重新開機主機
5. 重新連接到主機, 以繼續進行其餘設定

## <a name="creating-our-virtual-switch"></a>建立虛擬交換器

1. 在 [系統管理模式] 中開啟 PowerShell。
2. 建立內部交換器: `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. 將新建立的介面指派給 IP: `New-NetIPAddress –IPAddress 10.0.2.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"`

## <a name="install-and-configure-dhcp"></a>安裝和設定 DHCP

*許多人在第一次嘗試取得嵌套虛擬化時, 都會遺漏此元件。 在內部部署中, 您的來賓 Vm 會從主機所在的網路接收 DHCP, 而您必須透過其執行的主機提供 DHCP 的嵌套式 Vm。 或者, 您必須將 IP 位址靜態指派給每個嵌套式 VM (不具伸縮性)。*

1. 安裝 DHCP 角色: `Install-WindowsFeature DHCP -IncludeManagementTools`
2. 建立 DHCP 作用域: `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.2.2 -EndRange 10.0.2.254 -SubnetMask 255.255.255.0`
3. 設定作用中的 DNS 和預設閘道選項: `Set-DhcpServerV4OptionValue -DnsServer 168.63.129.16 -Router 10.0.2.1`
    * 如果您想要使用名稱解析, 請務必輸入有效的 DNS 伺服器。 在這種情況下, 我使用的是[Azure 的遞迴 DNS](https://docs.microsoft.com/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances)。

## <a name="installing-remote-access"></a>安裝遠端存取

1. 開啟 [伺服器管理員], 然後選取 [新增角色與功能]。
2. 選取 [下一步], 直到您到達「伺服器角色」為止。
3. 選取 [遠端存取], 然後按一下 [下一步], 直到您到達「角色服務」為止。
4. 選取 [路由], 選取 [新增功能], 然後選取 [下一步], 然後選取 [安裝]。 完成嚮導並等待安裝完成。

## <a name="configuring-remote-access"></a>設定遠端存取

1. 開啟 [伺服器管理員] 並選取 [工具], 然後選取 [路由與遠端存取]。
2. 在 [路由與遠端存取管理] 面板的左側, 您會看到一個圖示及其旁邊的 [伺服器名稱], 以滑鼠右鍵按一下這個圖示, 然後選取 [設定並啟用路由及遠端存取]。
3. 在嚮導中, 選取 [下一步], 檢查 [自訂設定] 的弧形按鈕, 然後選取 [下一步]。
4. 選取「NAT」和「局域網路由」, 然後選取 [下一步], 然後選取 [完成]。 如果它要求您啟動服務, 請執行此動作。
5. 現在, 流覽至 [IPv4] 節點並將它展開, 以使 [NAT] 節點可供使用。
6. 以滑鼠右鍵按一下 [NAT], 選取 [新介面 ...]。然後選取 [Ethernet], 就應該是第一個 IP 為 "10.0.0.4" 的 NIC
7. 現在, 我們需要建立一些靜態路由來強制局域網流量超出第二個 NIC。 您可以移至 [IPv4] 下的「靜態路由」節點來執行此動作。
8. 之後, 我們會建立下列路由。
    * Route 1
        * 介面: 乙太網路
        * 目的地: 10.0.0。0
        * 網路遮罩: 255.255.255。0
        * 閘道: 10.0.0。1
        * 公制: 256
        * 注意: 我們將它放在這裡, 讓主要 NIC 能回應傳送到自己介面的通信量。 如果我們在這裡沒有這個選項, 下列路由會造成 NIC 1 的流量, 以離開 NIC 2。 這會建立非對稱路由。 10.0.0.1 是 Azure 指派給 NAT 子網的 IP 位址。 Azure 使用範圍中的第一個可用 IP 作為預設閘道。 因此, 如果您是在 NAT 子網中使用 192.168.0.0/24, 閘道就會是192.168.0.1。 在 [路由更具體的路由 wins] 中, 這表示此路由將取代下列路由。

    * 路線2
        * 介面: 乙太網2
        * 目的地: 10.0.0。0
        * 網路遮罩: 255.255.252。0
        * 閘道: 10.0.1。1
        * 公制: 256
        * 注意: 這是適用于我們 Azure VNet 之流量的全部捕捉路線。 它會強制從第二個 NIC 傳送流量。 您必須為您想要嵌套式 Vm 存取的其他範圍新增其他路由。 因此, 如果您是內部部署網路是 172.16.0.0/22, 則您可能會想要使用另一個路線, 將該流量從我們的虛擬機器監控程式的第二個 NIC 傳送。

## <a name="creating-a-route-table-within-azure"></a>在 Azure 中建立路由表

如需深入瞭解在 Azure 中建立和管理路由, 請參閱[這篇文章](https://docs.microsoft.com/azure/virtual-network/tutorial-create-route-table-portal)。

1. 流覽至https://portal.azure.com。
2. 在左上角選取 [建立資源]。
3. 在搜尋欄位中輸入 "Route Table", 然後按 enter。
4. 上方的結果將會是路由表, 選取此值, 然後選取 [建立]
5. 在我的 case 中命名路由表, 並將其命名為「[路由-嵌套-Vm」]。
6. 請確定您選取的是您的 Hyper-v 主機所駐留的相同訂閱。
7. 您可以建立新的資源群組, 或選取現有的資源群組, 並確定您建立路由資料表的區域與您的 Hyper-v 主機所在的區域相同。
8. 選取 [建立]。

## <a name="configuring-the-route-table"></a>設定路由表

1. 流覽至我們剛剛建立的路由表。 您可以從入口網站上方中央的搜尋列中搜尋路由表的名稱來執行此動作。
2. 選取路由表之後, 請移至刀片式伺服器中的 [路由]。
3. 選取 [新增]。
4. 為您的路線命名, 我使用的是「嵌套式 Vm」。
5. 針對 [位址首碼] 輸入我們「浮動」子網上的 IP 範圍。 在這種情況下, 它會是 10.0.2.0/24。
6. 針對 "下一躍點類型", 選取 [虛擬裝置], 然後輸入 Hyper-v 主機第二個 NIC 的 IP 位址, 這會是 10.0.1.4, 然後選取 [確定]。
7. 從刀片式中開始選取 [子網], 這會直接位於 [路由] 下方。
8. 選取 [關聯], 然後選取我們的「嵌套趣味」 VNet, 然後選取 [Azure-Vm "子網上, 然後選取 [確定]。
9. 針對 Hyper-v 主機所駐留的子網以及任何其他需要存取嵌套式 Vm 的子網, 執行這個相同的程式。 如果已連線 

# <a name="end-state-configuration-reference"></a>結束狀態設定參考
本指南中的環境具有下列配置。 此區段是 inteded, 用來做為參照。

1. Azure 虛擬網路資訊。
    * VNet 高級配置。
        * 名稱: 內嵌的趣味
        * 位址空間: 10.0.0.0/22
        * 注意: 這將由四個子網組成。 此外, 這些範圍不會在石頭中設定。 您可以隨時隨意解決您的環境。 

    * 第一個子網高層級設定。
        * 名稱: NAT
        * 位址空間: 10.0.0.0/24
        * 注意: 這是我們的 Hyper-v 主機主要 NIC 所在的位置。 這將用來處理嵌套式 Vm 的輸出 NAT。 您的嵌套式 Vm 將是網際網路的閘道。

    * 第二個子網高層級設定。
        * Name (名稱): Hyper-v-局域網
        * 位址空間: 10.0.1.0/24
        * 注意: 我們的 Hyper-v 主機將會有第二個 NIC, 該 NIC 將用來處理位於 Hyper-v 主機外部的嵌套 Vm 與非網際網路資源之間的路由。

    * 第三個子網高層級設定。
        * 名稱: 重影
        * 位址空間: 10.0.2.0/24
        * 注意: 這會是「浮動」子網。 此位址空間將由我們的嵌套 Vm 佔用, 且存在, 以處理路由播發回到內部部署。 實際上沒有任何 Vm 會部署到這個子網中。

    * 第四個子網高層級設定。
        * 名稱: Azure-Vm
        * 位址空間: 10.0.3.0/24
        * 注意: 包含 Azure Vm 的子網。

1. 我們的 Hyper-v 主機具有下列 NIC 設定。
    * 主要 NIC 
        * IP 位址: 10.0.0。4
        * 子網路遮罩: 255.255.255。0
        * 預設閘道: 10.0.0。1
        * DNS: 針對 DHCP 進行設定
        * 已啟用 IP 轉移: 否

    * 次要 NIC
        * IP 位址: 10.0.1。4
        * 子網路遮罩: 255.255.255。0
        * 預設閘道: 空白
        * DNS: 針對 DHCP 進行設定
        * 已啟用 IP 轉移: 是

    * Hyper-v 已為內部虛擬交換器建立 NIC
        * IP 位址: 10.0.2。1
        * 子網路遮罩: 255.255.255。0
        * 預設閘道: 空白

3. 我們的路由資料表會有單一規則。
    * 規則1
        * 名稱: 嵌套式 Vm
        * 目的地: 10.0.2.0/24
        * 下一個躍點: 虛擬裝置-10.0.1。4

## <a name="conclusion"></a>總結

您現在應該可以將虛擬電腦 (即使是32位 VM!) 部署到您的 Hyper-v 主機, 而且可以從內部部署和 Azure 內部存取。
