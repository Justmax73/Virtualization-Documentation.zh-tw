---
title: 設定直接與 Azure 的虛擬網路中的資源通訊的巢狀虛擬機器
description: 巢狀虛擬化
keywords: windows 10 hyper-v Azure
author: mrajess
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: 2f1c6a124ba4f2f9d199d3cc5bb38c9082f72b3d
ms.sourcegitcommit: a7f9ab96be359afb37783bbff873713770b93758
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 05/28/2019
ms.locfileid: "9681138"
---
# <a name="configure-nested-vms-to-communicate-with-resources-in-an-azure-virtual-network"></a>設定 Azure 的虛擬網路中的資源與通訊的巢狀虛擬機器

部署及設定 Azure 內的巢狀的虛擬機器上的原始指導方針必須要在您透過 NAT 交換器存取這些 Vm。 這會顯示數個限制：

1. 巢狀虛擬機器無法存取資源內部部署或 Azure 虛擬網路內。
2. 內部部署資源或 Azure 中的資源，才能存取巢狀虛擬機器透過 NAT，這表示多個來賓不能共用相同的連接埠。

本文件會逐步引導部署，因此我們要使用的 RRAS，使用者定義路由致力於以允許來賓網際網路存取，以及 「 浮動 」 的位址空間輸出 NAT 子網路，以允許巢狀行為及通訊像任何其他虛擬機器的虛擬機器直接部署在 Azure 中 VNet。

請開始本指南中，： 之前

1. 請閱讀[以下提供的指導方針](https://docs.microsoft.com/azure/virtual-machines/windows/nested-virtualization)上巢狀虛擬化。
2. 閱讀本文整個之前的實作。

## <a name="high-level-overview-of-what-were-doing-and-why"></a>我們正在執行的高等級的概觀與原因
* 我們將建立兩個 Nic 的巢狀能夠 VM。 
* 其中一個 NIC 將用來提供網際網路存取，透過 NAT 和其他 NIC 我們巢狀虛擬機器將會用來從我們的內部交換器外部資源的流量路由傳送到 hypervisor。 每個 NIC 必須是在不同的路由網域，這表示不同子網路。
* 這表示，我們將需要在最小的三個子網路與虛擬網路。 另一個用於 NAT、 一個用於 LAN 路由，另一個，不會使用，但是 「 保留 」 給我們的巢狀虛擬機器。 我們使用針對此文件中的子網路的名稱為，「 NAT 」、 「 Hyper-v-V-區域網路 」 和 「 Ghosted 」。
* 這些子網路的大小是在您的審慎考慮後，但有一些考量。 「 Ghosted 」 子網路的大小會決定多少 Ip 您有巢狀 vm。 此外，在 「 NAT 」 和 「 Hyper-v-V-LAN 」 的子網路的大小會決定多少 Ip 的 Hypervisor。 因此技術上來說，如果您已計劃只於是否擁有一或兩個 hypervisor，您可以讓以下非常小的子網路。
* 背景： 巢狀虛擬機器將不會收到 DHCP 從其主機連接到，即使您的內部或外部交換器設定 VNet。 
  * 這表示 HYPER-V 主機必須提供 DHCP。
* HYPER-V 主機不知道的 VNet 上目前的受指派的租用，所以我們必須為避免在其中主機會指派一個 IP 已經存在的情況下配置的 Ip 區塊以只供 HYPER-V 主機。 這可讓我們可以避免重複的 IP 案例。
  * 我們選擇的 Ip 的區塊將會對應到的子網路中您 HYPER-V 是在相同 VNet。
  * 我們希望這會對應到現有的子網路的原因是為了處理回透過 ExpressRoute BGP 廣告。 如果我們剛建立以使用 HYPER-V 主機的 IP 範圍，則我們會建立一系列的靜態路由，讓用戶端有內部部署與巢狀虛擬機器進行通訊。 這表示這不硬碟的需求，因為您可能構成 IP 範圍的巢狀虛擬機器，然後建立直接存取該範圍的 HYPER-V 主機的用戶端所需的所有路由。
* 我們將會建立內部交換器 HYPER-V 內，然後我們將會指派新建立的介面的 IP 位址，我們將保留 dhcp 範圍內。 此 IP 位址會成為我們巢狀虛擬機器的預設閘道，且可用於內部交換器和主機連接到我們 VNet 的 NIC 之間的路線。
* 我們將會在主機上，這會將我們的主機，變成路由器安裝路由及遠端存取的角色。  這是必要允許外部主機的資源和我們的巢狀虛擬機器之間的通訊。
* 我們會告訴其他資源如何存取這些巢狀虛擬機器。 這樣會使用我們建立使用者定義路由表其中包含的靜態路由中的巢狀虛擬機器的 IP 範圍。 這個靜態路由會指向 HYPER-V 的 IP 位址。
* 您接著會將此 UDR 放閘道子網路上，因此來自內部部署的用戶端知道如何到達我們巢狀虛擬機器。
* 您也會將此 UDR 放在需要能連線到巢狀虛擬機器的 Azure 內的任何其他子網路上。
* 針對多個 HYPER-V 主機您會建立其他 「 浮動 」 的子網路，然後新增額外的靜態路由到 UDR。
* 當您解除委任 HYPER-V 主機時您將會刪除/重新規劃我們 「 浮動 」 的子網路和移除該靜態路由從我們 UDR，或如果這是最後一個的 HYPER-V 主機，移除 UDR 完全。

## <a name="creating-the-host"></a>建立主機

我將會透過最多個人喜好設定，例如 VM 名稱，資源群組等的任何設定值光面...

1. 瀏覽至 portal.azure.com
2. 按一下右上角的 [建立資源 \]
3. 從受歡迎的欄中選取 「 視窗 Server 2016 VM 」
4. 「 基本 」 索引標籤請務必選取能夠巢狀虛擬化的 VM 大小
5. 移至 [< 網路功能 >] 索引標籤
6. 使用下列設定建立新的虛擬網路
    * VNet 位址空間： 10.0.0.0/22
    * 子網路 1
        * 名稱： NAT
        * 位址空間： 10.0.0.0/24
    * 子網路 2
        * 名稱： 超-V-區域網路
        * 位址空間： 10.0.1.0/24
    * 子網路 3
        * 名稱： 建立映像
        * 位址空間： 10.0.2.0/24
    * 子網路 4
        * 名稱： Azure Vm
        * 位址空間： 10.0.3.0/24
7. 請確定您已選取之 vm 的 NAT 子網路
8. 移至 「 檢閱 + 建立 」，然後選取 「 建立 」

## <a name="create-the-second-network-interface"></a>建立第二個網路介面
1. 在 VM 之後完成佈建到它在 Azure 入口網站的瀏覽
2. 停止 VM
3. 在設定下的 < 網路功能 > 一次停止的前往
4. 「 附加網路介面 」
5. [建立網路介面 \]
6. 使其名稱 （不會影響您名稱，但請務必記住它）
7. 選取 「 Hyper-v-V-LAN 」 的子網路
8. 請確定您選取您的主機位於相同的資源群組
9. [建立 \]
10. 這會帶您回到先前的畫面，請務必選取新建立的網路介面，然後選取 \ [確定 \ 」
11. 返回 」 概觀 」 窗格，然後再次啟動您的 VM，一旦完成先前的動作
12. 瀏覽至我們剛建立的第二個 NIC，您可以它中找到您先前所選取的資源群組
13. 移至 「 IP 設定 」 和 「 IP 轉送 」 切換為 「 啟用 」 並儲存變更

## <a name="setting-up-hyper-v"></a>設定 HYPER-V
1. 遠端進入您的主機
2. 開啟提升權限的 PowerShell 提示字元
3. 執行下列命令 `Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart`
4. 這會重新啟動主機
5. 重新連接到主機，才能繼續進行其餘的安裝程式

## <a name="creating-our-virtual-switch"></a>建立我們的虛擬交換器

1. 在 \ [系統管理模式中開啟 PowerShell。
2. 建立內部交換器： `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. IP 指派新建立的介面： `New-NetIPAddress –IPAddress 10.0.2.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"`

## <a name="install-and-configure-dhcp"></a>安裝和設定 DHCP

*許多人會錯過這個元件時要第一次嘗試取得巢狀虛擬化工作。 不同於在內部之您客體虛擬機器將會收到 DHCP 從網路上，位於您的主機的 Azure 中的巢狀虛擬機器必須提供 DHCP 透過它們所執行的主機。 或您需要將靜態 IP 位址指派給每個巢狀的 VM，不是可調整。*

1. 安裝 DHCP 角色： `Install-WindowsFeature DHCP -IncludeManagementTools`
2. 建立 DHCP 領域： `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.2.2 -EndRange 10.0.2.254 -SubnetMask 255.255.255.0`
3. 設定 DNS 和預設閘道領域選項： `Set-DhcpServerV4OptionValue -DnsServer 168.63.129.16 -Router 10.0.2.1`
    * 請務必輸入有效的 DNS 伺服器，如果您想要的名稱解析才能運作。 我在此情況下使用[Azure 的遞迴 DNS](https://docs.microsoft.com/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances)。

## <a name="installing-remote-access"></a>安裝遠端存取

1. 開啟 \ [伺服器管理員，並選取 「 新增角色及功能 」。
2. 直到您取得 「 伺服器角色 」，請選取 「 下一步 」。
3. 檢查 「 遠端存取 」，然後按一下 [下一步 」 直到您取得 」 角色服務 」。
4. 檢查 「 路由 」，選取 [新增功能 \]，，然後選取 [下一頁]，然後再 「 安裝 」。 完成精靈，並等待完成安裝。

## <a name="configuring-remote-access"></a>設定遠端存取

1. 開啟伺服器管理員 \] 並選取 「 工具 」，然後選取 「 路由及遠端存取 」。
2. 路由及遠端存取管理面板左側上您會看到與您的伺服器名稱旁邊的圖示，以滑鼠右鍵按一下這並選取 「 設定和啟用路由及遠端存取 」。
3. 在精靈選取 [下一步 」、 「 自訂組態 」，檢查有放射狀按鈕，然後選取 「 下一步 」。
4. 檢查 「 NAT 」 和 「 LAN 路由 」，然後選取 「 下一步 」，並再 」 完成 」。 如果它會要求您啟動服務，然後執行這項操作。
5. 現在瀏覽至 「 IPv4 」 節點，然後展開位置，讓 「 NAT 」 節點會立即提供。
6. 以滑鼠右鍵按一下 「 NAT 」 中，選取 「 新介面...」選取"Ethernet"，這應該是您第一次 NIC 的 「 10.0.0.4 」 ip
7. 現在我們必須建立一些靜態路由，強制出第二個 NIC 的區域網路流量 移至 「 靜態路由 」 節點，在 「 IPv4 」 下執行此動作。
8. 一次那里我們會建立下列路線。
    * 路線 1
        * 介面： 乙太網路
        * 目的： 10.0.0.0
        * 網路遮罩： 255.255.255.0
        * 閘道： 10.0.0.1
        * 衡量標準： 256
        * 注意： 我們將它放在此以允許主要 NIC 來回應指定給它自己的介面出流量。 如果我們沒有這以下下列路線會導致適用於移出 NIC 2 NIC 1 的流量。 這會建立非對稱式的路線。 10.0.0.1 是 Azure 指派給 NAT 子網路的 IP 位址。 Azure 會使用第一個可用 IP 範圍中的預設閘道。 因此，如果您已在使用您的 NAT 子網路的 192.168.0.0/24，閘道會是 192.168.0.1。 Wins，這表示此路由將會取代路由更特定的路由中下方路線。

    * 路由 2
        * 介面： 乙太網路 2
        * 目的： 10.0.0.0
        * 網路遮罩： 為 255.255.252.0
        * 閘道： 10.0.1.1
        * 衡量標準： 256
        * 注意： 這是為了我們 Azure VNet 流量路由傳送所有 catch。 它會強制第二個 NIC 出流量 您將需要新增額外的路由的其他您想要存取您巢狀虛擬機器的範圍。 因此，如果您是在內部網路是 172.16.0.0/22，則您會想要有另一個路由傳送我們 hypervisor 第二個 NIC 出該流量。

## <a name="creating-a-route-table-within-azure"></a>建立 Azure 內的路由表

請參閱[這篇文章](https://docs.microsoft.com/azure/virtual-network/tutorial-create-route-table-portal)，如需深入了解讀取上建立和管理 Azure 的路由。

1. 瀏覽至https://portal.azure.com。
2. 左上角中選取 [建立資源 \]。
3. 在 [搜尋] 欄位中輸入 「 路由表 」，然後點擊輸入。
4. 上方的結果將會路由表，選取此選項，，然後選取 「 建立 」
5. 路由表的名稱，請在這個案例中我將它命名為 「 路由-適用於-巢狀-Vm 」。
6. 請確定您選取您的 HYPER-V 主機位於相同訂用帳戶。
7. 建立新的資源群組或選取現有，請確定您建立的路由表中的區域是您的 HYPER-V 主機位於相同區域。
8. 選取 [建立 \]。

## <a name="configuring-the-route-table"></a>設定路由表

1. 瀏覽到我們剛建立的路由表。 您可以搜尋從入口網站的中央頂端搜尋列路由表的名稱。
2. 選取之後路由表從瀏覽到 「 路由 」 刀鋒視窗內。
3. 選取 「 新增 」。
4. 為您的路線提供名稱，採用 「 巢狀虛擬機器 」。
5. 地址前置詞輸入我們 「 浮動 」 的子網路的 IP 範圍。 在此情況下，便會是 10.0.2.0/24。
6. 針對 「 下一個躍點類型 「 選取 」 虛擬設備 」，然後輸入 [IP 位址的 HYPER-V 裝載第二個 NIC，這可能會 10.0.1.4，而且然後選取 \ [確定 \ 」。
7. 現在內刀鋒視窗中選取 「 子網路 」，這將能從 「 路由 」 的正下方。
8. 選取 「 關聯 」，然後選取我們 「 巢狀有趣 」 VNet，然後選取 「 Azure Vm 」 的子網路，，然後選取 「 確定 」。
9. 對我們的 HYPER-V 主機位於也與其他需要存取巢狀虛擬機器的子網路的子網路中執行這個相同程序。 如果連線 

# <a name="end-state-configuration-reference"></a>結束狀態設定參考
本指南中的環境已設定下方。 此區段會 inteded 做為參考。

1. Azure 虛擬網路資訊。
    * VNet 高的層級組態。
        * 名稱： 巢狀有趣
        * 位址空間： 10.0.0.0/22
        * 注意： 這會是組成四個子網路。 此外，這些範圍不會設定定局。 放心地解決您的環境，但您需要。 

    * 第一個子網路高層級組態。
        * 名稱： NAT
        * 位址空間： 10.0.0.0/24
        * 注意： 這是我們 HYPER-V 其中裝載主要 NIC 所在。 這將會用來處理輸出 NAT 的巢狀虛擬機器。 它會為您的巢狀 Vm 網際網路閘道。

    * 第二個子網路高層級組態。
        * 名稱： 超-V-區域網路
        * 位址空間： 10.0.1.0/24
        * 注意： 我們的 HYPER-V 主機必須將用來處理之間的巢狀虛擬機器和非網際網路資源到 HYPER-V 主機的外部路由的第二個 NIC。

    * 第三個子網路高層級組態。
        * 名稱： 建立映像
        * 位址空間： 10.0.2.0/24
        * 注意： 這會是 「 浮動 」 的子網路。 位址空間將會由我們的巢狀虛擬機器，並存在來處理路由回到內部部署的廣告。 沒有 Vm 實際上會部署到此子網路。

    * 第四個子網路高層級組態。
        * 名稱： Azure Vm
        * 位址空間： 10.0.3.0/24
        * 注意： 包含 Azure Vm 的子網路。

1. 我們的 HYPER-V 主機有以下 NIC 設定。
    * 主要的 NIC 
        * IP 位址： 10.0.0.4
        * 子網路遮罩： 255.255.255.0
        * 預設閘道︰ 10.0.0.1
        * 針對 DHCP 設定 DNS:
        * 啟用 IP 轉送： 否

    * 次要 NIC
        * IP 位址： 10.0.1.4
        * 子網路遮罩： 255.255.255.0
        * 預設閘道： 空白
        * 針對 DHCP 設定 DNS:
        * 啟用 IP 轉送: [是]

    * Hyper-v 內部虛擬交換器為建立 NIC
        * IP 位址： 10.0.2.1
        * 子網路遮罩： 255.255.255.0
        * 預設閘道： 空白

3. 我們的路由表會有單一規則。
    * 規則 1
        * 名稱： 巢狀 Vm
        * 目的： 10.0.2.0/24
        * 下一個躍點： 虛擬設備 10.0.1.4

## <a name="conclusion"></a>總結

您現在應該可以部署到 HYPER-V 主機的虛擬機器 (甚至是 32 位元 VM ！)，並讓它可以存取從內部部署，並在 Azure 中。
